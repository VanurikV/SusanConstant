define("OK/metrics/YandexMetricService",["require","exports"],(function(require,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.YandexMetricService=e.SERVICE_NAME=void 0,e.SERVICE_NAME="ya-metrics",e.YandexMetricService={sendGoal:function(e,t){var r=window.ym,i=window.ymCounterId,n=Boolean(r&&i);return window.OK.logging.info('Sending ya metric goal: "'+e+'". Ya metrics was initialized: '+n),!!n&&(null==r||r(i,"reachGoal",e,t),!0)}}})),define("OK/metrics/MyTrackerService",["require","exports"],(function(require,e){"use strict";function t(e){var t=Boolean(window._tmr&&window._tmrCounterId),r="MyTracker was initialized: "+t;return e&&(r='Sending MyTracker metric goal: "'+e+'". '+r),window.OK.logging.info(r),t}function r(e,t,r){void 0===t&&(t={}),n({id:window._tmrCounterId,type:"reachGoal",goal:e,params:t,userid:r})}function i(e,t){n({id:window._tmrCounterId,url:e,referrer:t,type:"pageView"})}function n(e){window._tmr=window._tmr||[],window._tmr.push(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.trackPage=e.trackCustomGoal=e.checkTrackerInitialization=e.MyTrackerService=e.SERVICE_NAME=void 0,e.SERVICE_NAME="my-tracker",e.MyTrackerService={sendGoal:function(e,i){return!!t(e)&&(r(e,i),!0)},sendPageView:function(e,r){return!!t()&&(i(e,r),!0)}},e.checkTrackerInitialization=t,e.trackCustomGoal=r,e.trackPage=i})),define("OK/metrics/MetricsAnonymUserBehaviourImitation",["require","exports","./YandexMetricService","./MyTrackerService"],(function(require,e,t,r){"use strict";var i;Object.defineProperty(e,"__esModule",{value:!0}),function(e){e.PAGE_INIT="visit::init",e.LOGIN="visit::login",e.REJECT_IMITATION="visit::15s",e.GOOD_VISIT_IMITATION="visit::60s"}(i||(i={}));var n=function(){this.rejectImitationTimer=null,this.goodVisitImitationTimer=null};n.prototype.activate=function(e){var n=e.dataset.rejectImitationDuration?Number(e.dataset.rejectImitationDuration):15e3,a=e.dataset.visitImitationDuration?Number(e.dataset.visitImitationDuration):6e4;t.YandexMetricService.sendGoal(i.PAGE_INIT),r.MyTrackerService.sendGoal(i.PAGE_INIT),this.rejectImitationTimer=setTimeout((function(){t.YandexMetricService.sendGoal(i.REJECT_IMITATION),r.MyTrackerService.sendGoal(i.REJECT_IMITATION)}),n),this.goodVisitImitationTimer=setTimeout((function(){t.YandexMetricService.sendGoal(i.GOOD_VISIT_IMITATION),r.MyTrackerService.sendGoal(i.GOOD_VISIT_IMITATION)}),a)},n.prototype.deactivate=function(){clearTimeout(this.rejectImitationTimer),clearTimeout(this.goodVisitImitationTimer),this.rejectImitationTimer=null,this.goodVisitImitationTimer=null},e.default=n})),define("OK/metrics/MetricsLogOnInit",["require","exports","./YandexMetricService","./MyTrackerService"],(function(require,e,t,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.MetricsLogOnInit=void 0;var i=function(){};i.prototype.activate=function(e){var i;if(!e.dataset.goalNames)throw new Error("No goal name passed to YaMetricsLogOnInit");var n=e.dataset.goalNames.split(" "),a=(null===(i=e.dataset.excludedServices)||void 0===i?void 0:i.split(" "))||[],s=[];a.includes(t.SERVICE_NAME)||s.push(t.YandexMetricService),a.includes(r.SERVICE_NAME)||s.push(r.MyTrackerService),n.forEach((function(e){s.forEach((function(t){return t.sendGoal(e)}))}))},e.MetricsLogOnInit=i})),define("OK/metrics/ymOnClickSender",["require","exports"],(function(require,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.activate=void 0,e.activate=function(e){var t=e.getAttribute("data-goal-id");t&&window.hasOwnProperty("ym")&&e.addEventListener("click",(function(){window.ym(window.ymCounterId,"reachGoal",t)}))}})),define("OK/AjaxNavigationLog",["OK/logger"],(function(e){var t,r,i,n,a=!1;function s(e){if(e<0)return null;for(var t=[0,20,40,60,100,160,260,320,580,900],r=0;r<t.length-1;r++){var i=t[r],n=t[r+1];if(e>i&&e<=n)return i+"-"+n}return t[t.length-1]+"+"}function o(e,t){for(var r=t.substring(Math.max(0,t.indexOf("?")+1)).split("&"),i=0;i<r.length;i++){var n=r[i];if(0===n.indexOf(e+"="))return n.substr(e.length+1)}return""}return{log:function(n,c,u){if(a){var d=function(e){for(var r=o("st.cmd",e),i=o("cmd",e),n=0;n<t.length;n++){var a=t[n];if(a.indexOf("_")>-1){var s=a.split("_"),c=s[0],u=s[1];if("*"===c&&i===u)return u;if(r===c&&i===u)return r+"_"+i}else if(r===a)return a}return""}(c);if(d.length>0){e.duration("ajaxrequestdatatime.send.time",n,i+"_"+d,r);var p=(y=n)<100?1:(y>2e3&&(y=2e3),100*~~(y/100));p&&e.success("ad","ajax_"+i+"_"+d,p)}}var y;if(u){var l=u.split(":"),v=l[0],T=Number(l[1])/1e6,h=s(n),m=s(T);h&&m&&(e.success("ajaxrequestdatatime.client.measure",v,h),e.success("ajaxrequestdatatime.server.measure",v,m))}},activate:function(e){var s,o,c;n||(s=e.textContent,o=e.getAttribute("data-region"),c=e.getAttribute("data-countrycode"),r=o,i=c,t=JSON.parse(s),a=!0,n=!0)},deactivate:function(){t.length=0,r="",i="",n=!1}}})),define("OK/utils/screens",{apply:function(e){var t,r;"true"===document.body.getAttribute("data-uic")&&OK.getCurrentDesktopModelId&&(t=OK.getCurrentDesktopModelId(),OK.Layers&&OK.Layers.isAnyLayerOpened()&&(r=t,t=OK.Layers.getTopLayerId()),t&&e.setRequestHeader("OK-Screen",t),r&&e.setRequestHeader("OK-PrevScreen",r))}}),define("OK/utils/vanilla",["OK/AjaxNavigationLog","OK/utils/screens"],(function(e,t){"use strict";function r(e){var t=[],r=function(e,r){t.push(encodeURIComponent(e)+"="+encodeURIComponent(r))};for(var i in e)if(e.hasOwnProperty(i)){var n=e[i];Array.isArray(n)?n.forEach(r.bind(null,i)):r(i,e[i])}return t.join("&")}function i(i,n){var a=i.type||"POST",s=i.data||{},o=i.contentType,c=i.dataType,u=i.responseType,d=i.url||"",p=i.isExternal||/^(https?:)?\/\//.test(d),y={xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":"*/*"},l=i.headers||{},v={},T=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,h=i.beforeOpen,m=new XMLHttpRequest;if(n||(n=function(e){OK.navigation.redirect?OK.navigation.redirect(e):document.location.href=decodeURIComponent(e)}),"POST"===a&&"string"!=typeof s)if(i.isFileUpload){l["Content-Type"]="application/octet-stream";var g=(s.name||"1.jpg").replace(/[^\u0000-\u007F]+/gi,"_").substring(0,255);l["Content-Disposition"]='attachment; filename="'+g+'"'}else l["Content-Type"]="application/x-www-form-urlencoded",window.pageCtx.gwtHash&&(s["gwt.requested"]=window.pageCtx.gwtHash),s=r(s);o&&y.hasOwnProperty(o)&&!l.hasOwnProperty("Content-Type")&&(l["Content-Type"]=y[o]),c&&y.hasOwnProperty(c)&&!l.hasOwnProperty("Accept")&&(l.Accept="*"===c?y[c]:y[c]+", */*; q=0.01"),p||l.hasOwnProperty("TKN")||(l.TKN=OK.tkn.get()),p||l.hasOwnProperty("STRD")||(l.STRD=OK.isStateRedesign()),p||l.hasOwnProperty("STRV")||(l.STRV=OK.getRedesignVersion()),p||(l[OK.CLIENT_FLAGS_HEADER]=OK.getClientFlags());var f=OK.getStatId();!p&&f&&(l[OK.STAT_ID_HEADER]=f);var I=new Promise((function(r,o){var y=window.performance.now();for(var g in h&&h({xhr:m}),m.open(a,d,!0),l)l.hasOwnProperty(g)&&m.setRequestHeader(g,l[g]);p||t.apply(m),u&&(m.responseType=u),m.onreadystatechange=function(){if(m.readyState===XMLHttpRequest.HEADERS_RECEIVED){for(var t,i=m.getAllResponseHeaders();t=T.exec(i);)v[t[1].toLowerCase()]=t[2];if(!p&&v["redirect-location"])return n(v["redirect-location"]),void o(m,m.statusText,"Redirect")}if(m.readyState===XMLHttpRequest.DONE)if(m.status>=200&&m.status<300||304===m.status){e.log(window.performance.now()-y,d,m.getResponseHeader("X-Render-Time"));var a=u?m.response:m.responseText,s=a;if("json"===c)try{s=JSON.parse(a)}catch(e){o(e)}!p&&v.tkn&&OK.tkn.set(v.tkn),!p&&v.hasOwnProperty(OK.CLIENT_FLAGS_HEADER)&&OK.setClientFlags(v[OK.CLIENT_FLAGS_HEADER]),!p&&OK.state&&window.OK.state.processXhrResponse(m),OK.util.processCssHeaders(m).then((function(){r({response:s,xhr:m})}))}else o(m)},m.onerror=function(){o(m)};var f=i.signal;f&&f.addEventListener("abort",(function(){m.abort(),o(m)})),m.send(s)}));return I.xhr=m,I}function n(e){var t=e.getResponseHeader(OK.navigation.HEADER);return t?t.split(","):null}function a(e,t){e.split(OK.navigation.SPLITER).forEach((function(e,r){t[r]&&OK.hookModel.setHookContent(t[r],e)}))}return{ajax:i,getJSON:function(e,t,r){return i(Object.assign({type:"GET",dataType:"json",url:e,data:t},r))},trigger:function(e,t,r){if(e&&3!==e.nodeType&&8!==e.nodeType){var i=document.createEvent("CustomEvent");i.initCustomEvent(t,!0,!0,r),e.dispatchEvent(i)}},encodeHtml:function(e){var t=document.createElement("div");return e.split(" ").map((function(e){return t.innerText=e,t.innerHTML})).join(" ")},extractParams:function(e){var t={},r=e&&e.indexOf("?");return r>-1&&e.substr(r+1).split("&").forEach((function(e){if(e.indexOf("=")>-1){var r=e.split("="),i=r[0],n=r[1];n=decodeURIComponent(n.replace(/\+/g,"%20")),t[i]=n}})),t},stringifyParams:r,appendParamsToUrl:function(e,t){return null!=t&&(e+=(-1===e.indexOf("?")?"?":"&")+r(t)),e},getBlockIds:n,updateBlocks:a,updateBlockModelCallback:function(e){var t=n(e.xhr);t&&a(e.response,t)},getFormData:function(e){return Array.prototype.slice.apply(e.getElementsByTagName("input")).reduce((function(e,t){return t.name&&(e[t.name]="checkbox"===t.type?t.checked?"on":"off":t.value),e}),{})},unescapeXml:function(e){return e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&apos;/g,"'")},escapeXml:function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")},stripTags:function(e){var t=document.createElement("div");return t.innerHTML=e,t.innerText},formatNumber:function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")}}})),define("OK/utils/parseJsonConf",["require","exports"],(function(require,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.parseStorageJsonConf=e.parseJsonConf=void 0;e.parseJsonConf=function(e,t){var r=e.getAttribute(t);if(null!=r)try{return JSON.parse(r)}catch(e){return null}return null};e.parseStorageJsonConf=function(e,t){var r=e.getItem(t);if(null!=r)try{return JSON.parse(r)}catch(e){return null}return null}})),define("OK/webapi",["OK/utils/vanilla","OK/logger"],(function(e,t){"use strict";var r="/web-api/v2/",i=!0,n=0,a=!1,s="api.communication-error";function o(n,o,c){var u=function(e){return r+e}(n),d=function(e){return i?JSON.stringify(e,null,2):JSON.stringify(e)}(o);return new Promise((function(r,i){var n=e.ajax({contentType:"application/json; charset=utf-8",url:u,dataType:"json",data:d}),o=n.xhr;function p(){o.abort(),a=!0,y(),i({type:2,typeName:"ABORT",errorCode:"abort",errorMessage:o.statusText||"abort"})}function y(){c.signal&&c.signal.removeEventListener("abort",p)}c.signal&&c.signal.addEventListener("abort",p),n.then((function(e){a=!1,y();var t=e.response;t.success?r(t.result):i(t.error)}),(function(e){a||t.error(s),y(),a=!0,i({type:200,typeName:"SERVER_ERROR",errorCode:s,errorMessage:e.statusText||s})}))}))}var c={invoke:function(e,t,r){var i={id:++n},a=(r=r||{}).filter;return null!=t&&(i.parameters=t),null!=a&&(i.filter=a),o(e,i,r)}};return"undefined"!=typeof window&&(window.webapi=c),c})),define("OK/MediascopeTracker",["require","exports","OK/utils/parseJsonConf","OK/utils/vanilla"],(function(require,e,t,r){"use strict";var i,n;Object.defineProperty(e,"__esModule",{value:!0}),e.MediascopeTracker=void 0,function(e){e.FEED="FEED",e.GAMES="GAMES",e.VIDEOS="VIDEOS",e.HOBBY="HOBBY",e.MESSAGES="MESSAGES",e.OTHER="OTHER",e.PLAYER="PLAYER"}(i||(i={})),function(e){e.START="3",e.CONTINUATION="4",e.END="5"}(n||(n={}));var a=window.localStorage,s=function(){var e=this;this.isPlayerViaLayer=!1,this.wasPlayerEndSent=!1,this.shouldSendPlayerHeartbeat=!1,this.layerWasJustReset=!1,this.initForPage=function(t,r){e.currentLayerId=OK.Layers.getTopLayerId(),e.refreshActivityTypes(),OK.Layers.subscribeGlobal(e.onLayerToggle),e.debugLog("Init finished! Current stateId: "+e.currentStateId),e.processState(t,r)},this.initForPlayer=function(t){e.lastPlayerLogTimestamp=t,e.shouldSendPlayerHeartbeat=!0,document.addEventListener("__videoPlayerEvent",e.onVideoPlayerEvent),document.addEventListener("adv",e.onVideoPlayerEvent)},this.onLayerToggle=function(){var t=e.currentActivityType,r=OK.Layers.getTopLayerId();e.layerWasJustReset=!1,null===r?setTimeout((function(){e.layerWasJustReset||(e.prevLayerId=e.currentLayerId,e.currentLayerId=r),e.performLayerChange(t)}),e.layerResetTime):(e.prevLayerId=e.currentLayerId,e.currentLayerId=r,e.layerWasJustReset=!0,setTimeout((function(){e.layerWasJustReset&&e.performLayerChange(t)}),e.layerResetTime))},this.onVideoPlayerEvent=function(){var t=Date.now();(e.debugLog("player event! Session will be started or extended."),e.lastPlayerLogTimestamp&&!isNaN(e.lastPlayerLogTimestamp))?t-e.lastPlayerLogTimestamp-500>=e.pingInterval||e.wasPlayerEndSent?(e.lastPlayerLogTimestamp=t,e.wasPlayerEndSent=!1,e.sendHeartbeats(t,!0,!0)):e.shouldSendPlayerHeartbeat=!0:(e.lastPlayerLogTimestamp=t,e.sendHeartbeats(t,!0,!0));if(!e.playerTimerId){var r=t-e.lastPlayerLogTimestamp,i=e.pingInterval-r;(isNaN(r)||r>e.pingInterval||0===r)&&(i=e.pingInterval),e.playerTimerId=setTimeout((function(){e.debugLog("Video timeout expired. Will be send: "+e.shouldSendPlayerHeartbeat),e.shouldSendPlayerHeartbeat&&(e.lastPlayerLogTimestamp=Date.now(),e.sendHeartbeats(e.lastPlayerLogTimestamp,!1,!0)),e.playerTimerId=null}),i)}},this.sendHeartbeatsTimerWrapper=function(){e.timerId=setTimeout((function(){return e.sendHeartbeatsTimerWrapper()}),e.pingInterval),e.sendHeartbeats()},this.sendHeartbeats=function(t,r,a,s){void 0===t&&(t=Date.now()),void 0===r&&(r=!1),void 0===a&&(a=!1),void 0===s&&(s="");var o=e.formatDate(t),c=[];if(r&&e.prevActivityType&&!a){var u=n.END,d=e.prevActivityType,p=e.calcUrl(u,d);c.push(e.sendHeartbeat(p,d,u,o,s))}var y=r?n.START:n.CONTINUATION,l=a?i.PLAYER:e.currentActivityType,v=e.calcUrl(y,l);return a?e.saveVideoData(t):e.saveData(l,t),c.push(e.sendHeartbeat(v,l,y,o,s)),Promise.all(c)}};s.prototype.activate=function(e){var r,i=this,n=(0,t.parseJsonConf)(e,"data-core-config"),a=n.targetHost,s=n.storageKey,o=n.pingInterval,c=n.isUserAuthorized,u=n.searchParamsToSend,d=n.typeToId,p=(0,t.parseJsonConf)(e,"data-page-logging-config"),y=(0,t.parseJsonConf)(e,"data-player-logging-config");if(this.withPageLogging=void 0===p.withPageLogging||p.withPageLogging,this.withPlayerLogging=void 0===y.withPlayerLogging||y.withPlayerLogging,this.targetHost=a||".ms.ok.ru",this.storageKey=s||"ms.state",this.pingInterval=o?Number(o):3e4,this.isUserAuthorized=c,this.searchParamsToSend=u,this.typeToId=d,this.withPageLogging){var l=p.currentStateId,v=p.defaultActivityType,T=p.layerResetTime,h=p.typeToStateId,m=p.typeToLayerId;this.currentStateId=l,this.layerResetTime=T?Number(T):100,this.defaultActivityType=v,this.stateIdToType=this.revertMap(h),this.layerIdToType=this.revertMap(m),r=this.restoreData(),OK.loader.use("OKCustomJs",(function(){i.initForPage(null==r?void 0:r.activityType,null==r?void 0:r.timestamp)}))}this.withPlayerLogging&&(this.isEmbeddedPlayer=y.isEmbeddedPlayer,r=r||this.restoreData(),this.initForPlayer(null==r?void 0:r.playerTimestamp))},s.prototype.deactivate=function(){this.withPageLogging&&(clearInterval(this.timerId),OK.Layers.unsubscribeGlobal(this.onLayerToggle)),this.withPlayerLogging&&(clearTimeout(this.playerTimerId),this.playerTimerId=null,document.removeEventListener("__videoPlayerEvent",this.onVideoPlayerEvent),document.removeEventListener("adv",this.onVideoPlayerEvent))},s.prototype.performLayerChange=function(e){var t=this.isPlayerViaLayer;this.refreshActivityTypes(),this.debugLog("layerId change! Current layerId: "+this.currentLayerId+". CurrentType: "+this.currentActivityType+", prevType: "+e),this.currentActivityType!==e&&this.processState(e),this.withPlayerLogging&&t&&this.performPlayerEnding()},s.prototype.performPlayerEnding=function(){var e=this;if(this.prevLayerId&&!this.currentLayerId){setTimeout((function(){clearTimeout(e.playerTimerId),e.playerTimerId=null,e.wasPlayerEndSent=!0}),100);var t=n.END,r=i.PLAYER,a=this.calcUrl(t,r),s=this.formatDate(Date.now());this.sendHeartbeat(a,r,t,s)}},s.prototype.processState=function(e,t){var r,i=e!==this.currentActivityType,n=Date.now();if(i)return this.prevActivityType=e,this.sendHeartbeats(n,!0),void this.resetTimer();if(t&&!isNaN(t)){var a=n-t;r="Time diff: "+this.formatDate(a)+". Prev time: "+this.formatDate(t)+".",a>=this.pingInterval?(this.sendHeartbeats(n,!0,!1,r),this.resetTimer()):this.timerId||this.resetTimer(this.pingInterval-a)}else this.sendHeartbeats(n,!0),this.resetTimer()},s.prototype.refreshActivityTypes=function(){var e;if(this.prevActivityType=this.currentActivityType,this.isPlayerViaLayer=!1,this.currentLayerId){var t=this.layerIdToType[this.currentLayerId];return(null==t?void 0:t.length)?(this.isPlayerViaLayer=!0,void(this.currentActivityType=t[0])):(this.debugLog('current layerId "'+this.currentLayerId+'" is not binded to type!'),void(this.currentActivityType=this.defaultActivityType))}(null===(e=this.stateIdToType[this.currentStateId])||void 0===e?void 0:e.length)?this.currentActivityType=this.stateIdToType[this.currentStateId][0]:(this.debugLog('current stateId "'+this.currentStateId+'" is not binded to type. So we fallback to it as to "other" type.'),this.currentActivityType=this.defaultActivityType)},s.prototype.sendHeartbeat=function(e,t,i,n,a){return void 0===a&&(a=""),this.debugLog("\n            Sending signal!\n            Activity type: "+t+".\n            Session event: "+i+".\n            Timestamp: "+n+".\n            Url: "+e+".\n            "+a),r.ajax({url:e,type:"GET",data:null,isExternal:!0})},s.prototype.calcUrl=function(e,t){var r=this;return"https://"+[this.typeToId[t],e,this.isEmbeddedPlayer?3:2,2,this.isUserAuthorized?2:3,1].join("")+this.targetHost+(this.searchParamsToSend?"?"+Object.keys(this.searchParamsToSend).map((function(e){return e+"="+r.searchParamsToSend[e]})).join("&"):"")},s.prototype.revertMap=function(e){if(!e)return{};var t={},r=function(r){e[r].forEach((function(e){t[e]?t[e].push(r):t[e]=[r]}))};for(var i in e)r(i);return t},s.prototype.saveData=function(e,t){try{a.setItem(this.storageKey,JSON.stringify({activityType:e,timestamp:t,playerTimestamp:this.lastPlayerLogTimestamp}))}catch(e){this.debugLog("Error while saving data to storage!")}},s.prototype.saveVideoData=function(e){var t=this.restoreData()||{};t&&(t.playerTimestamp=e),a.setItem(this.storageKey,JSON.stringify(t))},s.prototype.restoreData=function(){try{return(0,t.parseStorageJsonConf)(a,this.storageKey)}catch(e){return this.debugLog("Error while restoring data from storage!"),null}},s.prototype.resetTimer=function(e){void 0===e&&(e=this.pingInterval),clearTimeout(this.timerId),this.timerId=setTimeout(this.sendHeartbeatsTimerWrapper,e)},s.prototype.debugLog=function(){for(var e,t=[],r=arguments.length;r--;)t[r]=arguments[r];OK.fn.isDebug()&&(e=OK.logging).info.apply(e,["[MediascopeTracker]"].concat(t))},s.prototype.formatDate=function(e){return new Date(e).toLocaleTimeString("ru")},e.MediascopeTracker=s})),define("OK/metrics/TimespentTrackerService",["require","exports"],(function(require,e){"use strict";function t(e,t){var r=Boolean(window._tmr);return!!r||(window.OK.logging.info("Sending MyTracker "+e+' timespent: "'+t+'". MyTracker was initialized: '+r),!1)}function r(e){window._tmr=window._tmr||[],window._tmr.push(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.TimespentTrackerService=void 0,e.TimespentTrackerService={startTimespent:function(e,i){t("start",e)&&function(e,t){r({id:t,type:"startTimespent",activity:e,canUseInBackground:!1})}(e,i)},stopTimespent:function(e,i){t("stop",e)&&function(e,t){r({id:t,type:"stopTimespent",activity:e})}(e,i)}}})),define("OK/metrics/TimespentTrackerTypes",["require","exports"],(function(require,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ActivityId=e.ActivityType=void 0,function(e){e.FEED="FEED",e.GAMES="GAMES",e.VIDEOS="VIDEOS",e.HOBBY="HOBBY",e.MESSAGES="MESSAGES",e.OTHER="OTHER",e.PLAYER="PLAYER"}(e.ActivityType||(e.ActivityType={})),function(e){e[e.FEED=32]="FEED",e[e.GAMES=34]="GAMES",e[e.VIDEOS=33]="VIDEOS",e[e.HOBBY=79]="HOBBY",e[e.MESSAGES=37]="MESSAGES",e[e.OTHER=36]="OTHER",e[e.PLAYER=35]="PLAYER"}(e.ActivityId||(e.ActivityId={}))})),define("OK/TimespentTracker",["require","exports","OK/utils/parseJsonConf","OK/metrics/MyTrackerService","OK/metrics/TimespentTrackerService","OK/metrics/TimespentTrackerTypes"],(function(require,e,t,r,i,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TimespentTracker=void 0;var a=null,s=function(){var e=this;this.isTimespentStarted=!1,this.needCheckProgress=!0,this.playerViaLayer=!1,this.isMovieEnd=!1,this.layerWasJustReset=!1,this.delayInitForLayers=function(){e.currentLayerId=OK.Layers.getTopLayerId(),e.refreshActivityTypes(),OK.Layers.subscribeGlobal(e.onLayerToggle),e.debugLog("Init finished! Current stateId: "+e.currentStateId),e.processState(e.prevActivityType),e.withPlayerLogging&&(document.addEventListener("__videoPlayerEvent",e.onVideoPlayerEvent),document.addEventListener("adv",e.onVideoPlayerEvent))},this.onLayerToggle=function(){var t=e.currentActivityType,r=OK.Layers.getTopLayerId();e.layerWasJustReset=!1,null===r?setTimeout((function(){e.layerWasJustReset||(e.prevLayerId=e.currentLayerId,e.currentLayerId=r),e.performLayerChange(t)}),e.layerResetTime):(e.prevLayerId=e.currentLayerId,e.currentLayerId=r,e.layerWasJustReset=!0,setTimeout((function(){e.layerWasJustReset&&e.performLayerChange(t)}),e.layerResetTime))},this.onVideoPlayerEvent=function(t){switch(e.isMovieEnd=t.detail.data.duration==t.detail.data.value,t.detail.name){case"started":case"play":e.isTimespentStarted||(e.currentMovieId=t.detail.data.movieId,e.startPlayerTimespent());break;case"pause":e.stopPlayerTimespent();break;case"progress":if(!e.needCheckProgress)break;e.isMovieEnd?e.stopPlayerTimespent():e.currentMovieId!==t.detail.data.movieId||e.isTimespentStarted||e.startPlayerTimespent()}}};s.prototype.activate=function(e){var r=this;this.timespentAccountId=Number(e.dataset.timespentAccountId),this.layerResetTime=e.dataset.layerResetTime?Number(e.dataset.layerResetTime):100,this.progressEventIgnoreTime=e.dataset.progressEventIgnoreTime?Number(e.dataset.progressEventIgnoreTime):1e3,this.defaultActivityType=e.dataset.defaultActivityType,this.withPlayerLogging="true"===e.dataset.withPlayerLogging,this.typeToId=(0,t.parseJsonConf)(e,"data-type-to-id");var i=(0,t.parseJsonConf)(e,"data-type-to-state-id");this.stateIdToType=this.revertMap(i);var n=(0,t.parseJsonConf)(e,"data-type-to-layer-id");this.layerIdToType=this.revertMap(n),this.currentStateId=e.dataset.currentStateId,OK.loader.use("OKCustomJs",(function(){return r.delayInitForLayers()}))},s.prototype.deactivate=function(){OK.Layers.unsubscribeGlobal(this.onLayerToggle),this.stopTimespentByType(a),this.withPlayerLogging&&(this.isTimespentStarted&&this.stopPlayerTimespent(),document.removeEventListener("__videoPlayerEvent",this.onVideoPlayerEvent),document.removeEventListener("adv",this.onVideoPlayerEvent))},s.prototype.performLayerChange=function(e){this.refreshActivityTypes(),this.debugLog("layerId change! Current layerId: "+this.currentLayerId+". CurrentType: "+this.currentActivityType+", prevType: "+e),this.currentActivityType!==e&&(this.stopTimespentByType(e),this.startTimespentByType(this.currentActivityType))},s.prototype.processState=function(e,t){var r=e!==this.currentActivityType;return a?r?(this.prevActivityType=e,this.stopTimespentByType(a),a=this.getCurrentActivityType(),void this.startTimespentByType(a)):void 0:(a=this.currentActivityType,void this.startTimespentByType(a))},s.prototype.getCurrentActivityType=function(){var e,t;return(null===(t=null===(e=this.stateIdToType)||void 0===e?void 0:e[this.currentStateId])||void 0===t?void 0:t[0])||this.defaultActivityType},s.prototype.refreshActivityTypes=function(){var e;if(this.prevActivityType=this.currentActivityType,this.playerViaLayer=!1,this.currentLayerId){var t=this.layerIdToType[this.currentLayerId];return(null==t?void 0:t.length)?(this.playerViaLayer=!0,void(this.currentActivityType=t[0])):(this.debugLog('current layerId "'+this.currentLayerId+'" is not binded to type!'),void(this.currentActivityType=this.defaultActivityType))}(null===(e=this.stateIdToType[this.currentStateId])||void 0===e?void 0:e.length)?this.currentActivityType=this.getCurrentActivityType():this.currentActivityType=this.defaultActivityType},s.prototype.revertMap=function(e){if(!e)return{};var t={},r=function(r){e[r].forEach((function(e){t[e]?t[e].push(r):t[e]=[r]}))};for(var i in e)r(i);return t},s.prototype.startPlayerTimespent=function(){this.startTimespentByType(n.ActivityType.PLAYER),this.isTimespentStarted=!0},s.prototype.stopPlayerTimespent=function(){var e=this;this.stopTimespentByType(n.ActivityType.PLAYER),this.needCheckProgress=!1,this.isTimespentStarted=!1,setTimeout((function(){e.needCheckProgress=!0}),1e3)},s.prototype.startTimespentByType=function(e){r.MyTrackerService.sendPageView(document.URL,document.referrer),i.TimespentTrackerService.startTimespent(this.typeToId[e],this.timespentAccountId)},s.prototype.stopTimespentByType=function(e){i.TimespentTrackerService.stopTimespent(this.typeToId[e],this.timespentAccountId)},s.prototype.debugLog=function(){for(var e,t=[],r=arguments.length;r--;)t[r]=arguments[r];OK.fn.isDebug()&&(e=OK.logging).info.apply(e,["[TimespentTracker]"].concat(t))},e.TimespentTracker=s})),define("b/metrics",["require","exports","OK/metrics/MetricsAnonymUserBehaviourImitation","OK/metrics/MetricsLogOnInit","OK/metrics/MyTrackerService","OK/metrics/YandexMetricService","OK/metrics/ymOnClickSender","OK/utils/vanilla","OK/utils/parseJsonConf","OK/webapi","OK/MediascopeTracker","OK/TimespentTracker"],(function(require,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=/res/source-maps/js/b/metrics.js.map