define(["require","exports","OK/utils/throttle","OK/utils/vanilla","OK/utils/environment","OK/capture","OK/viewport","OK/logger"],(function(require,t,e,i,n,o,s,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ScrollSlider=void 0;var l=[],a=function(t){this.slider=t};a.prototype.goRight=function(){for(var t=this.slider,e=t.items,i=t.cnt.getBoundingClientRect(),n=0,o=e.length;n<o;n++){var s=e[n].getBoundingClientRect();if(s.right>i.right){var r=n===o-1?0:50;return void this.slider.animateScroll(s.left-i.left-r)}}},a.prototype.goLeft=function(){for(var t=this.slider,e=t.items,i=t.cnt.getBoundingClientRect(),n=e.length-1;n>=0;n--){var o=e[n].getBoundingClientRect();if(o.left<i.left){var s=0===n?0:50;return void this.slider.animateScroll(o.right-i.right+s)}}},a.prototype.destroy=function(){this.slider=null};var h=function(t){this.slider=t,this.THRESHOLD=24};h.prototype.getCenterOfRect=function(t){return t.left+(t.right-t.left)/2},h.prototype.goRight=function(){for(var t=this.slider,e=t.items,i=t.cnt,n=t.el.getBoundingClientRect(),o=i.getBoundingClientRect(),s=this.getCenterOfRect(n),r=0,l=e.length;r<l;r++){var a=e[r].getBoundingClientRect();if(this.getCenterOfRect(a)-s>this.THRESHOLD)return void this.slider.animateScroll(a.left-o.left-(n.width-a.width)/2)}var h=e[e.length-1].getBoundingClientRect();this.slider.animateScroll(h.left-o.left)},h.prototype.goLeft=function(){for(var t=this.slider,e=t.items,i=t.cnt,n=t.el.getBoundingClientRect(),o=i.getBoundingClientRect(),s=this.getCenterOfRect(n),r=e.length-1;r>=0;r--){var l=e[r].getBoundingClientRect();if(s-this.getCenterOfRect(l)>this.THRESHOLD)return void this.slider.animateScroll(l.left-o.left-(n.width-l.width)/2)}var a=e[0].getBoundingClientRect();this.slider.animateScroll(a.right-o.right)},h.prototype.destroy=function(){this.slider=null};var c=function(){var t=this;this._hovered=!1,this.loading=!1,this._animationId=0,this.logSeenInterceptionValue=.9,this.dragData=null,this.page=1,this.throttledUpdateView=e(500,(function(){t.updateView(),t.customEvent&&t.createCustomSlideEvent("slideend")})),this.onMouseWheel=function(e){var i=t.cnt;e.deltaX<0&&0===i.scrollLeft&&e.preventDefault(),e.deltaX>0&&i.scrollLeft+i.offsetWidth===i.scrollWidth&&e.preventDefault()},this.onHover=this.onHover.bind(this),this.onLeave=this.onLeave.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onBodyMouseMove=this.onBodyMouseMove.bind(this),this.onBodyMouseUp=this.onBodyMouseUp.bind(this),this.onScrollContainerClick=e(9,!0,this.onScrollContainerClick.bind(this)),this.scrollToEnd=this.scrollToEnd.bind(this)};function d(t,e,i,n){return(t/=n/2)<1?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e}c.prototype.activate=function(t){if(this.el=t,this.items=t.querySelectorAll(".scroll-slider_list > *"),this.items.length){var e=t.querySelector(".scroll-slider_list");if(this.cnt=e,this.btnLeft=t.querySelector(".scroll-slider_btn.__left"),this.btnRight=t.querySelector(".scroll-slider_btn.__right"),"center"===t.getAttribute("data-scroll-manager"))this.scrollManager=new h(this);else this.scrollManager=new a(this);this.loadUrl=t.getAttribute("data-load-url");try{this.loadData=JSON.parse(t.getAttribute("data-load-data"))}catch(t){}this.loadMarker=t.getAttribute("data-load-marker"),this.lastElement=t.getAttribute("data-load-last-element"),this.loadDistance=parseInt(t.getAttribute("data-load-distance"),10)||500;var i=t.getAttribute("data-load-page");i&&(this.page=parseInt(i,10)),this.customEvent=t.getAttribute("data-custom-event"),this.seenLoggerEntrancePlace=t.getAttribute("data-seen-logger-entrance-place"),t.addEventListener("mousedown",this.onMouseDown),t.addEventListener("mouseenter",this.onHover),t.addEventListener("mouseleave",this.onLeave),e.addEventListener("animationstart",this.throttledUpdateView),e.addEventListener("scroll",this.throttledUpdateView),e.addEventListener("wheel",this.onMouseWheel),e.addEventListener("scrollToEnd",this.scrollToEnd),this.btnLeft.addEventListener("click",this),this.btnRight.addEventListener("click",this),t.getAttribute("data-scroll-item-onclick")&&e.addEventListener("click",this.onScrollContainerClick),this.updateView(),this.showItemOnActivate()}},c.prototype.deactivate=function(){var t;if(this.items.length){var e=this.cnt,i=this.el;i.removeEventListener("mousedown",this.onMouseDown),i.removeEventListener("mouseenter",this.onHover),i.removeEventListener("mouseleave",this.onLeave),e.removeEventListener("animationstart",this.throttledUpdateView),e.removeEventListener("scroll",this.throttledUpdateView),e.removeEventListener("wheel",this.onMouseWheel),e.removeEventListener("scrollToEnd",this.scrollToEnd),e.removeEventListener("click",this.onScrollContainerClick),this.btnLeft&&this.btnLeft.removeEventListener("click",this),this.btnRight&&this.btnRight.removeEventListener("click",this)}null===(t=this.scrollManager)||void 0===t||t.destroy()},c.prototype.showItemOnActivate=function(){var t=this.el.getAttribute("data-show-item");if(t){var e=this.items,i=Number(t);if(!isNaN(i)&&i>=0&&i<e.length){var n=e[i];n&&this.scrollToItem(n)}}},c.prototype.updateView=function(){var t=this.cnt.getBoundingClientRect(),e=this.items[this.items.length-1].getBoundingClientRect().right-t.right,i=this.cnt.scrollLeft>=15,n=e>=15;this.btnLeft.classList.toggle("__visible",i),this.btnRight.classList.toggle("__visible",i?n:n&&this._hovered),this.loadItems(e),this.logSeenCards()},c.prototype.loadItems=function(t){var e=this;if(this.loadUrl&&!this.loading&&(this.loadMarker||this.lastElement)&&!(t>this.loadDistance)){this.loading=!0;var o=Object.assign({fetch:!1},this.loadData);this.loadMarker?o.marker=this.loadMarker:o["st.lastelem"]=this.lastElement,o["st.page"]=this.page;var s=this.onLoad.bind(this);i.ajax({url:this.loadUrl,data:o}).then(s).catch((function(t){n.isDebug&&window.console.error("ScrollSlider loadItems error",t)})).then((function(){e.loading=!1}))}},c.prototype.onLoad=function(t){if(this.loadMarker=t.xhr.getResponseHeader("marker"),"true"===t.xhr.getResponseHeader("fetchedAll")?this.lastElement=null:this.lastElement=t.xhr.getResponseHeader("lastelem"),this.page=this.page+1,t.response){var e=this.cnt.lastChild;if(this.cnt.insertAdjacentHTML("beforeend",t.response),this.customEvent)for(var i=e.nextSibling;i;)i instanceof HTMLElement&&o.activate(i),i=i.nextSibling;this.items=this.el.querySelectorAll(".scroll-slider_list > *"),this.updateView()}},c.prototype.onMouseDown=function(t){1===t.which&&(t.preventDefault(),this.dragData={x:t.screenX,scroll:this.cnt.scrollLeft,preventEvents:!1},document.body.addEventListener("mousemove",this.onBodyMouseMove,!0),document.body.addEventListener("mouseup",this.onBodyMouseUp,!0))},c.prototype.onBodyMouseMove=function(t){var e=t.screenX-this.dragData.x;this.cnt.scrollLeft=this.dragData.scroll-e,!this.dragData.preventEvents&&Math.abs(e)>5&&(this.cnt.style.pointerEvents="none",this.el.style.cursor="pointer",this.dragData.preventEvents=!0)},c.prototype.onBodyMouseUp=function(t){var e=this;if(document.body.removeEventListener("mousemove",this.onBodyMouseMove,!0),document.body.removeEventListener("mouseup",this.onBodyMouseUp,!0),this.dragData.preventEvents){t.preventDefault();var i=function(t){t.stopPropagation(),t.preventDefault(),e.cnt.style.pointerEvents=null,e.el.style.cursor=null,document.body.removeEventListener("click",i,!0)};document.body.addEventListener("click",i,!0)}this.dragData=null},c.prototype.onHover=function(){this._hovered=!0,this.updateView()},c.prototype.onLeave=function(){this._hovered=!1,this.updateView()},c.prototype.onScrollContainerClick=function(t){var e=t.target,i=[].find.call(this.items,(function(t){return t.contains(e)}));i&&this.scrollToItem(i)},c.prototype.handleEvent=function(t){var e=t.target;return this.btnLeft.contains(e)?this.goLeft():this.btnRight.contains(e)?this.goRight():void 0},c.prototype.createCustomSlideEvent=function(t,e){void 0===e&&(e=null),this.customEvent&&"function"==typeof CustomEvent&&i.trigger(this.el,"ScrollSliderAction",{action:t,data:e})},c.prototype.goLeft=function(){this.scrollManager.goLeft()},c.prototype.goRight=function(){this.scrollManager.goRight()},c.prototype.scrollToEnd=function(){for(var t=this.cnt.getBoundingClientRect(),e=0,i=this.items.length;e<i;e++){var n=this.items[e].getBoundingClientRect();n.right>t.right&&this.animateScroll(n.left-t.left)}},c.prototype.scrollToItem=function(t){var e=this.cnt.getBoundingClientRect(),i=t.getBoundingClientRect(),n=0;(i.left<e.left||i.right>e.right)&&(n=i.left-e.left-.5*e.width+.5*i.width),n&&this.animateScroll(n)},c.prototype.animateScroll=function(t){var e=this,i=this.cnt,n=function(t){var e=Math.min(500,Math.max(300,3*Math.abs(t)));return Math.floor(e)}(t),o=d,s=Date.now(),r=i.scrollLeft,l=r;this._animationId=s;var a=function(){if(e._animationId===s){var h=Math.min(Date.now()-s,n),c=Math.round(o(h,r,t,n));i.scrollLeft+=c-l,l=c,h<n?requestAnimationFrame(a):e.customEvent&&e.createCustomSlideEvent("slideend")}};requestAnimationFrame(a)},c.prototype.logSeenCards=function(){for(var t=Array.prototype.slice.call(this.items),e=[],i=0,n=t.length;i<n;i++){var o=t[i],r=o.getAttribute("data-id");r&&-1===l.indexOf(r)&&s.isElementPartiallyInViewport(o,this.logSeenInterceptionValue)&&(l.push(r),e.push(r))}if(e.length){var a={isExplicitView:!1,place:"photo.scroll-slider",entrancePlace:this.seenLoggerEntrancePlace,action:"SHOW",ids:e.join(",")};this.log("seen","PHOTO",JSON.stringify(a))}},c.prototype.log=function(t,e,i){r.success(t,e,i)},t.ScrollSlider=c}));
//# sourceMappingURL=/res/source-maps/js/app/ScrollSlider.js.map